/* stackloop.js
 * version 0.3
 * written by Steven Hunt
 * released under the MIT License. */

var stackloop=stackloop||{version:"0.3"};(function(e){e.context=function(t,n){this.wait=n!==undefined?n:0;if(this.wait==0){this.timeout=function(e){window.setZeroTimeout(e)}}else{this.timeout=function(e){window.setTimeout(e,this.wait)}}this.context=t!==undefined?t:this;var r=new Array;var i=function(e){r.push(e)};var s=function(){return r.pop()};var o=function(){return r[r.length-1]};var u=this;var a=function(t,n,r,a,f){this.context=u.context;this.condition=null;var l=1;if(r===false&&typeof t==="function"){this.current=null;this.currentIndex=null;this.condition=t;l=5}else if(r.constructor===Array){this.current=r[t];this.currentIndex=t;l=4}else if(typeof r=="string"||r instanceof String){this.current=r.charAt(t);this.currentIndex=t;l=3}else if(isNaN(r)){this.keys=Object.keys(r);this.current=r[this.keys[t]];this.currentIndex=t;l=2}else this.current=t;i(this);var c=new e.deferred(this);c.then(f,null,a);var h=function(e,t,n){if(t<3)c.success();else c.fail(n);s();return false};this.proceed=function(){switch(l){case 1:return this.current<n;case 2:return this.currentIndex<this.keys.length;case 3:case 4:return this.currentIndex<r.length}return true};this.increment=function(){switch(l){case 1:this.current+=r;break;case 2:this.currentIndex++;this.current=this.currentIndex<this.keys.length?r[this.keys[this.currentIndex]]:null;break;case 3:this.currentIndex++;this.current=this.currentIndex<r.length?r.charAt(this.currentIndex):null;break;case 4:this.currentIndex++;this.current=this.currentIndex<r.length?r[this.currentIndex]:null;break;case 5:if(!this.condition.call(this))return h(null,1);break}this.step()};this.step=function(){if(o()!==this){var e=this;u.timeout(function(){e.step()});return null}if(!this.proceed())return h(this.current,1);var t=this;u.timeout(function(){var e=false;try{e=c.step(t.current)}catch(n){e=false;return h(t.current,3,n)}if(e===false)h(t.current,2);else t.increment()});return true};this.start=function(){this.step();return c.promise}};this.forCount=function(e,t,n,r){var i=new a(e,t,1,n,r);return i.start()};this.forRange=function(e,t,n,r,i){var s=new a(e,t,n,r,i);return s.start()};this.forEach=function(e,t,n){var r=new a(0,e.length,e,t,n);return r.start()};this.whileTrue=function(e,t,n){var r=new a(e,true,false,t,n);return r.start()}};e.deferred=function(t){this.promise=new e.promise(this);var n=new Array;var r=new Array;var i=new Array;this.then=function(e,t,s){if(typeof e==="function")n.push(e);if(typeof t==="function")r.push(t);if(typeof s==="function")i.push(s);return this};this.success=function(){for(var e=0;e<n.length;e++){n[e].call(t)}};this.fail=function(e){for(var n=0;n<r.length;n++){r[n].call(t,e)}};this.step=function(e){var n=true;for(var r=0;r<i.length;r++){if(i[r].call(t.context,e)===false)n=false}return n}};e.promise=function(e){this.then=function(t,n,r){e.then(t,n,r);return this};this.success=function(t){e.then(t,null,null);return this};this.fail=function(t){e.then(null,t,null);return this};this.step=function(t){e.then(null,null,t);return this}}})(stackloop);(function(){if(!window.setZeroTimeout){var e=[];var t="zero-timeout-message";function n(n){e.push(n);window.postMessage(t,"*")}function r(n){if(n.source==window&&n.data==t){n.stopPropagation();if(e.length>0){var r=e.shift();r()}}}window.addEventListener("message",r,true);window.setZeroTimeout=n}})()